.setProperty('--s8Ready','1'); }
  if (s8Img && s8Img.complete && s8Img.naturalWidth > 0) markS8Ready();
  else if (s8Img) s8Img.addEventListener('load', markS8Ready, { once:true });

  const galCImg0 = document.getElementById('galC-img0');
  let galCFirstReady = false;
  function markGalCReady(){ galCFirstReady = true; root.style.setProperty('--galCReady','1'); }
  if (galCImg0 && galCImg0.complete && galCImg0.naturalWidth > 0) markGalCReady();
  else if (galCImg0) galCImg0.addEventListener('load', markGalCReady, { once:true });

  function update(){
    /* HERO choreography */
    const p=progressOf(driver);
    const pFade=easeInOutCubic(clamp(p/0.60,0,1));
    root.style.setProperty('--titleOpacity',pFade.toFixed(3));
    const pSlide=clamp((p-0.60)/0.40,0,1);
    const shift=startShift+(endShift-startShift)*pSlide;
    root.style.setProperty('--shift',shift.toFixed(1)+'px');
    root.style.setProperty('--linksOpacity',pSlide.toFixed(3));

    /* Progress */
    const s1=progressOf(s1Wrap);
    const s2=progressOf(s2Wrap);
    const galA=progressOf(galAWrap);
    const s3=progressOf(s3Wrap);
    const s4=progressOf(s4Wrap);
    const s5=progressOf(s5Wrap);
    const galB=progressOf(galBWrap);
    const s8=progressOf(s8Wrap);
    const s9=progressOf(s9Wrap);
    const galC=progressOf(galCWrap);

    root.style.setProperty('--s1',s1.toFixed(3));
    root.style.setProperty('--s2',s2.toFixed(3));
    root.style.setProperty('--galA',galA.toFixed(3));
    root.style.setProperty('--s3',s3.toFixed(3));
    root.style.setProperty('--s4',s4.toFixed(3));
    root.style.setProperty('--s5',s5.toFixed(3));
    root.style.setProperty('--galB',galB.toFixed(3));
    root.style.setProperty('--s8',s8.toFixed(3));
    root.style.setProperty('--s9',s9.toFixed(3));
    root.style.setProperty('--galC',galC.toFixed(3));

    /* Overlays & hero */
    root.style.setProperty('--s1Overlay',(s1>0 && s1<1)?1:0);
    root.style.setProperty('--s2Overlay',(s2>0 && s2<1)?1:0);
    root.style.setProperty('--s4Overlay',(s4>0 && s4<1)?1:0);
    root.style.setProperty('--s5Overlay',(s5>0 && s5<1)?1:0);
    root.style.setProperty('--s9Overlay',(s9>0 && s9<1)?1:0);
    root.style.setProperty('--heroAlpha',(1-s1).toFixed(3));
    root.style.setProperty('--heroBlur',(s1*0.8).toFixed(3));

    /* Text sweeps */
    const textEase = 0.8;
    const s1Raw=clamp((s1-0.75)/0.25,0,1);
    const s1Y=s1StartY+(s1EndY-s1StartY)*easePow(s1Raw,textEase);
    root.style.setProperty('--s1Y', s1Y+'px');

    const s2Raw=clamp((s2-0.25)/0.75,0,1);
    const s2Y=s2StartY+(s2EndY-s2StartY)*easePow(s2Raw,textEase);
    root.style.setProperty('--s2Y', s2Y+'px');

    const s4Raw=clamp((s4-0.75)/0.25,0,1);
    const s4Y=s4StartY+(s4EndY-s4StartY)*easePow(s4Raw,textEase);
    root.style.setProperty('--s4Y', s4Y+'px');

    const s5Raw=clamp((s5-0.25)/0.75,0,1);
    const s5Y=s5StartY+(s5EndY-s5StartY)*easePow(s5Raw,textEase);
    root.style.setProperty('--s5Y', s5Y+'px');

    const s9Raw=clamp((s9-0.75)/0.25,0,1);
    const s9Y=s9StartY+(s9EndY-s9StartY)*easePow(s9Raw,textEase);
    root.style.setProperty('--s9Y', s9Y+'px');

    /* S3 end zoom */
    const s3ZoomRaw = clamp((s3 - 0.82) / 0.18, 0, 1);
    root.style.setProperty('--s3Scale', (1 + 0.08 * easeInOutCubic(s3ZoomRaw)).toFixed(3));

    /* S8 end zoom */
    const s8ZoomRaw = clamp((s8 - 0.82) / 0.18, 0, 1);
    root.style.setProperty('--s8Scale', (1 + 0.08 * easeInOutCubic(s8ZoomRaw)).toFixed(3));

    /* ===== Crossfades (global) ===== */
    const FADE_FRAC = 0.35;
    const LEAD_FRAC = 0.15;

    /* S1 → S2 */
    const s1In = clamp(s1/FADE_FRAC, 0, 1);
    const textBottomS1 = s1Y + s1Text.scrollHeight;
    const gateS1S2 = (textBottomS1 <= window.innerHeight * LEAD_FRAC) ? 1 : 0;
    const x12 = clamp(s2/FADE_FRAC, 0, 1);
    let s1Alpha = Math.min(gateS1S2 ? (1 - x12) : 1, s1In);
    let s2Alpha = gateS1S2 ? x12 : 0;

    /* S2 → gallery-A */
    const textBottomS2 = s2Y + s2Text.scrollHeight;
    const gateS2A = (textBottomS2 <= window.innerHeight * LEAD_FRAC) || (s2 >= 0.999);
    const x2A = clamp(galA/FADE_FRAC, 0, 1);
    const galAGroup = (gateS2A && galAFirstReady) ? x2A : 0;
    if (gateS2A) s2Alpha = s2Alpha * (1 - x2A);

    /* gallery-A → S3 */
    const xA3 = clamp(s3/FADE_FRAC, 0, 1);
    let galAAlpha = galAGroup * (1 - xA3);
    const s3Alpha = xA3;

    /* S3 → S4 */
    const x34 = clamp(s4/FADE_FRAC, 0, 1);
    let s4Alpha = x34;
    const s3AlphaOut = s3Alpha * (1 - x34);

    /* S4 → S5 */
    const textBottomS4 = s4Y + s4Text.scrollHeight;
    const gateS4S5 = (textBottomS4 <= window.innerHeight * LEAD_FRAC) || (s4 >= 0.999);
    const x45 = clamp(s5/FADE_FRAC, 0, 1);
    let s5Alpha = gateS4S5 ? x45 : 0;
    if (gateS4S5) s4Alpha = s4Alpha * (1 - x45);

    /* S5 → gallery-B (center) */
    const textBottomS5 = s5Y + s5Text.scrollHeight;
    const gateS5B = (textBottomS5 <= window.innerHeight * LEAD_FRAC) || (s5 >= 0.999);
    const x5B = clamp(galB/FADE_FRAC, 0, 1);
    const galBGroup = (gateS5B && galBFirstReady) ? x5B : 0;
    if (gateS5B) s5Alpha = s5Alpha * (1 - x5B);

    /* gallery-B → S8 (full-bleed), gated on S8 first image load */
    const xB8 = clamp(s8/FADE_FRAC, 0, 1);
    const s8Group = s8FirstReady ? xB8 : 0;

    /* S8 → S9 (like S3→S4) */
    const x89 = clamp(s9/FADE_FRAC, 0, 1);
    let s9Alpha = x89;
    const s8AlphaOut = s8Group * (1 - x89);

    /* NEW: S9 → gallery-C (gate by S9 text bottom + first C image) */
    const textBottomS9 = s9Y + s9Text.scrollHeight;
    const gateS9C = (textBottomS9 <= window.innerHeight * LEAD_FRAC) || (s9 >= 0.999);
    const x9C = clamp(galC/FADE_FRAC, 0, 1);
    const galCGroup = (gateS9C && galCFirstReady) ? x9C : 0;
    if (gateS9C) s9Alpha = s9Alpha * (1 - x9C);

    /* ===== Internal galleries ===== */

    /* gallery-A (3 imgs, +25% holds) */
    const INTERNAL_START_A = FADE_FRAC;
    const tA = clamp((galA - INTERNAL_START_A) / (1 - INTERNAL_START_A), 0, 1);
    const A_FADE_FRAC_BASE = 0.30, HOLD_MULT_A = 1.25;
    const HA_raw = (1 - 2*A_FADE_FRAC_BASE)/3;
    const totalARaw = 3*(HA_raw*HOLD_MULT_A) + 2*A_FADE_FRAC_BASE;
    const NORMA = 1/totalARaw;
    const A_FADE_FRAC = A_FADE_FRAC_BASE*NORMA;
    const A_HOLD = HA_raw*HOLD_MULT_A*NORMA;
    const TA_1 = A_HOLD, TA_2 = TA_1 + A_FADE_FRAC + A_HOLD;
    const step = (t,start,w)=>clamp((t - start)/w, 0, 1);

    let a0=0,a1=0,a2=0;
    if (tA <= 0){ a0=1; } else {
      a0=1;
      const g1=step(tA, TA_1, A_FADE_FRAC); a0*= (1 - g1); a1 = Math.max(a1, g1);
      const g2=step(tA, TA_2, A_FADE_FRAC); a1*= (1 - g2); a2 = Math.max(a2, g2);
    }
    root.style.setProperty('--galAImg0Opacity', (a0 * galAGroup * (1 - xA3)).toFixed(3));
    root.style.setProperty('--galAImg1Opacity', (a1 * galAGroup * (1 - xA3)).toFixed(3));
    root.style.setProperty('--galAImg2Opacity', (a2 * galAGroup * (1 - xA3)).toFixed(3));

    /* gallery-B (5 imgs, +25% holds) */
    const INTERNAL_START_B = FADE_FRAC;
    const tB = clamp((galB - INTERNAL_START_B) / (1 - INTERNAL_START_B), 0, 1);
    const N_B=5, F_B=N_B-1, B_FADE_FRAC_BASE=0.22, HOLD_MULT_B=1.25;
    const HB_raw = (1 - F_B*B_FADE_FRAC_BASE)/N_B;
    const totalBRaw = N_B*(HB_raw*HOLD_MULT_B) + F_B*B_FADE_FRAC_BASE;
    const NORMB=1/totalBRaw;
    const B_FADE_FRAC=B_FADE_FRAC_BASE*NORMB;
    const B_HOLD=HB_raw*HOLD_MULT_B*NORMB;
    const TB_1=B_HOLD, TB_2=TB_1+B_FADE_FRAC+B_HOLD, TB_3=TB_2+B_FADE_FRAC+B_HOLD, TB_4=TB_3+B_FADE_FRAC+B_HOLD;

    let b0=0,b1=0,b2=0,b3=0,b4=0;
    if (tB <= 0){ b0=1; } else {
      b0=1;
      const f1=step(tB, TB_1, B_FADE_FRAC); b0*= (1 - f1); b1 = Math.max(b1, f1);
      const f2=step(tB, TB_2, B_FADE_FRAC); b1*= (1 - f2); b2 = Math.max(b2, f2);
      const f3=step(tB, TB_3, B_FADE_FRAC); b2*= (1 - f3); b3 = Math.max(b3, f3);
      const f4=step(tB, TB_4, B_FADE_FRAC); b3*= (1 - f4); b4 = Math.max(b4, f4);
    }
    const galBOut = (1 - s8Group);
    root.style.setProperty('--galBImg0Opacity', (b0 * galBGroup * galBOut).toFixed(3));
    root.style.setProperty('--galBImg1Opacity', (b1 * galBGroup * galBOut).toFixed(3));
    root.style.setProperty('--galBImg2Opacity', (b2 * galBGroup * galBOut).toFixed(3));
    root.style.setProperty('--galBImg3Opacity', (b3 * galBGroup * galBOut).toFixed(3));
    root.style.setProperty('--galBImg4Opacity', (b4 * galBGroup * galBOut).toFixed(3));

    /* NEW: gallery-C (5 imgs, +25% holds; starts after group is in) */
    const INTERNAL_START_C = FADE_FRAC;
    const tC = clamp((galC - INTERNAL_START_C) / (1 - INTERNAL_START_C), 0, 1);
    const N_C=5, F_C=N_C-1, C_FADE_FRAC_BASE=0.22, HOLD_MULT_C=1.25;
    const HC_raw = (1 - F_C*C_FADE_FRAC_BASE)/N_C;
    const totalCRaw = N_C*(HC_raw*HOLD_MULT_C) + F_C*C_FADE_FRAC_BASE;
    const NORMC=1/totalCRaw;
    const C_FADE_FRAC=C_FADE_FRAC_BASE*NORMC;
    const C_HOLD=HC_raw*HOLD_MULT_C*NORMC;
    const TC_1=C_HOLD, TC_2=TC_1+C_FADE_FRAC+C_HOLD, TC_3=TC_2+C_FADE_FRAC+C_HOLD, TC_4=TC_3+C_FADE_FRAC+C_HOLD;

    let c0=0,c1=0,c2=0,c3=0,c4=0;
    if (tC <= 0){ c0=1; } else {
      c0=1;
      const h1=step(tC, TC_1, C_FADE_FRAC); c0*= (1 - h1); c1 = Math.max(c1, h1);
      const h2=step(tC, TC_2, C_FADE_FRAC); c1*= (1 - h2); c2 = Math.max(c2, h2);
      const h3=step(tC, TC_3, C_FADE_FRAC); c2*= (1 - h3); c3 = Math.max(c3, h3);
      const h4=step(tC, TC_4, C_FADE_FRAC); c3*= (1 - h4); c4 = Math.max(c4, h4);
    }

    root.style.setProperty('--galCImg0Opacity', (c0 * galCGroup).toFixed(3));
    root.style.setProperty('--galCImg1Opacity', (c1 * galCGroup).toFixed(3));
    root.style.setProperty('--galCImg2Opacity', (c2 * galCGroup).toFixed(3));
    root.style.setProperty('--galCImg3Opacity', (c3 * galCGroup).toFixed(3));
    root.style.setProperty('--galCImg4Opacity', (c4 * galCGroup).toFixed(3));

    /* Apply section frame opacities */
    root.style.setProperty('--s1ImgOpacity', s1Alpha.toFixed(3));
    root.style.setProperty('--s2ImgOpacity', s2Alpha.toFixed(3));
    root.style.setProperty('--s3ImgOpacity', s3AlphaOut.toFixed(3));
    root.style.setProperty('--s4ImgOpacity', s4Alpha.toFixed(3));
    root.style.setProperty('--s5ImgOpacity', s5Alpha.toFixed(3));
    root.style.setProperty('--s8ImgOpacity', s8AlphaOut.toFixed(3));
    root.style.setProperty('--s9ImgOpacity', s9Alpha.toFixed(3));
  }

  async function init(){
    if(document.fonts && document.fonts.ready){ try{ await document.fonts.ready; }catch(e){} }
    measureHero(); measureS1(); measureS2(); measureS4(); measureS5(); measureS9(); update();
    addEventListener('load', ()=>{ measureHero(); measureS1(); measureS2(); measureS4(); measureS5(); measureS9(); update(); });
    addEventListener('resize', ()=>{ measureHero(); measureS1(); measureS2(); measureS4(); measureS5(); measureS9(); update(); });
    addEventListener('scroll', update, {passive:true});
  }
  init();
})();
</script>
</body>
</html>
